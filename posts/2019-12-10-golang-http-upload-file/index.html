<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>The Go Developer's Guide to HTTP File Uploads using net/http Package - POLOXUE's BLOG</title><meta name=viewport content="width=device-width,initial-scale=1">
<meta itemprop=name content="The Go Developer's Guide to HTTP File Uploads using net/http Package"><meta itemprop=description content="The previous post presented a comprehensive introduction to sending HTTP requests using Go&rsquo;s net/http, covering all methods commonly used in daily scenarios. However, as the focus was primarily on usage, some topics, such as the implementation principles of HTTP file uploads, might still be challenging to understand without a deeper understanding of the underlying mechanics.
Today, based on this topic, we will delve into how Go implements file uploads."><meta itemprop=datePublished content="2024-01-25T15:05:54+08:00"><meta itemprop=dateModified content="2024-01-25T15:05:54+08:00"><meta itemprop=wordCount content="1056"><meta itemprop=keywords content><meta property="og:title" content="The Go Developer's Guide to HTTP File Uploads using net/http Package"><meta property="og:description" content="The previous post presented a comprehensive introduction to sending HTTP requests using Go&rsquo;s net/http, covering all methods commonly used in daily scenarios. However, as the focus was primarily on usage, some topics, such as the implementation principles of HTTP file uploads, might still be challenging to understand without a deeper understanding of the underlying mechanics.
Today, based on this topic, we will delve into how Go implements file uploads."><meta property="og:type" content="article"><meta property="og:url" content="https://en.poloxue.com/posts/2019-12-10-golang-http-upload-file/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-25T15:05:54+08:00"><meta property="article:modified_time" content="2024-01-25T15:05:54+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="The Go Developer's Guide to HTTP File Uploads using net/http Package"><meta name=twitter:description content="The previous post presented a comprehensive introduction to sending HTTP requests using Go&rsquo;s net/http, covering all methods commonly used in daily scenarios. However, as the focus was primarily on usage, some topics, such as the implementation principles of HTTP file uploads, might still be challenging to understand without a deeper understanding of the underlying mechanics.
Today, based on this topic, we will delve into how Go implements file uploads."><script data-goatcounter=https://enpoloxue.goatcounter.com/count async src=//gc.zgo.at/count.js></script><link rel=stylesheet type=text/css media=screen href=https://en.poloxue.com/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://en.poloxue.com/css/main.css><link rel=stylesheet type=text/css media=screen href=https://en.poloxue.com/css/extra.css><link id=dark-scheme rel=stylesheet type=text/css href=https://en.poloxue.com/css/dark.css><script src=https://en.poloxue.com/js/feather.min.js></script><script src=https://en.poloxue.com/js/main.js></script></head><body><div class="container-wide wrapper"><div class=header><div class=avatar><a href=https://en.poloxue.com/><img src=/avatar.webp alt="POLOXUE's BLOG"></a></div><h1 class=site-title><a href=https://en.poloxue.com/>POLOXUE's BLOG</a></h1><div class=site-description><nav class="nav social"><ul class=flat><li><a href=https://github.com/poloxue/ title=Github><i data-feather=github></i></a></li><li><a href=/index.xml title=RSS><i data-feather=rss></i></a></li><span class=scheme-toggle><a href=# id=scheme-toggle></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>HOME</a></li><li><a href=/posts>POSTS</a></li><li><a href=/tags>TAGS</a></li><li><a href=/about/>ABOUT</a></li></ul></nav></div><div class=article-nav id=article-nav-id><div class=post><div class=post-header><div class=meta><div class=date><span class=day>25</span>
<span class=rest>Jan 2024</span></div></div><div class=matter><h1 class=title>The Go Developer's Guide to HTTP File Uploads using net/http Package</h1></div></div><aside class="show-on-mobile toc" id=static-toc><header><h3>Contents</h3></header><nav id=TableOfContents><ol><li><a href=#introduction>Introduction</a></li><li><a href=#submitting-forms>Submitting Forms</a></li><li><a href=#file-upload-rfc-1867>File Upload RFC 1867</a></li><li><a href=#implementation>Implementation</a></li><li><a href=#conclusion>Conclusion</a></li></ol></nav></aside><p><img src=https://cdn.jsdelivr.net/gh/poloxue/images@2024-01/2024-01-25-golang-http-upload-file-01.webp alt></p><p>The previous post presented a comprehensive introduction to sending HTTP requests using Go&rsquo;s net/http, covering all methods commonly used in daily scenarios. However, as the focus was primarily on usage, some topics, such as the implementation principles of HTTP file uploads, might still be challenging to understand without a deeper understanding of the underlying mechanics.</p><p>Today, based on this topic, we will delve into how Go implements file uploads.</p><h2 id=introduction>Introduction</h2><p>In simple terms, HTTP file upload can be divided into three steps: organizing the request body, setting the Content-Type, and sending the POST request. We won&rsquo;t delve into POST requests here but will instead focus on the request body and the content type of the request body.</p><p>The request body is commonly used for POST requests. Although GET also supports a request body, it is conventionally ignored by the server due to established norms.</p><p>What is Content-Type?</p><p>The format of the request body is not fixed and can be quite varied. To clarify the content type of the request body, HTTP defines a request header called Content-Type.</p><p>Common Content-Type options include <code>application/x-www-form-urlencoded</code> (default form submission), <code>application/json</code> (json), <code>text/xml</code> (xml format), <code>text/plain</code> (plain text), and <code>application/octet-stream</code> (binary stream), among others.</p><h2 id=submitting-forms>Submitting Forms</h2><p>File upload can be understood as a special case of form submission. Let&rsquo;s introduce the whole process with a simple example of form submission.</p><p>Below is the HTTP request text for form submission.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#a6e22e>POST</span> http://httpbin.org/post <span style=color:#66d9ef>HTTP</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1.1</span>
</span></span><span style=display:flex><span>Content-Type<span style=color:#f92672>:</span> <span style=color:#ae81ff>application/x-www-form-urlencoded</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>username=poloxue&amp;password=123456
</span></span></code></pre></td></tr></table></div></div><p>The Content-Type is <code>application/x-www-form-urlencoded</code>, and the data is organized in a urlencoded manner.</p><p>Let&rsquo;s first implement it with an HTML form, as shown below:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>form</span> <span style=color:#a6e22e>method</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;post&#34;</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;text&#34;</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;username&#34;</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;password&#34;</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;password&#34;</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;submit&#34;</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>form</span>&gt;
</span></span></code></pre></td></tr></table></div></div><p>Submitting the form via POST, the default Content-Type is <code>application/x-www-form-urlencoded</code>.</p><p>Go&rsquo;s implementation code:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>data</span> <span style=color:#f92672>:=</span> make(<span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>Values</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;username&#34;</span>, <span style=color:#e6db74>&#34;poloxue&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;password&#34;</span>, <span style=color:#e6db74>&#34;123456&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Organize data in urlencoded format
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>body</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>Encode</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Create a request and set the content type
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>request</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>NewRequest</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>MethodPost</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;http://httpbin.org/post&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#a6e22e>body</span>),
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Set</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;content-type&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;application/x-www-form-urlencoded&#34;</span>,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>DefaultClient</span>.<span style=color:#a6e22e>Do</span>(<span style=color:#a6e22e>request</span>)
</span></span></code></pre></td></tr></table></div></div><p>Reflect on the three steps mentioned earlier: organizing request body data, setting Content-Type, and sending the request.</p><p>Go&rsquo;s net/http package also offers a more concise method, http.Post.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Post</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;http://httpbin.org/post&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;application/x-www-form-urlencoded&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#a6e22e>body</span>),
</span></span><span style=display:flex><span>)
</span></span></code></pre></td></tr></table></div></div><h2 id=file-upload-rfc-1867>File Upload RFC 1867</h2><p>The need for file uploads is common, but the default form submission method does not support it.</p><p>If it&rsquo;s a single file upload, it can be implemented through a binary stream in the body. However, for more complex scenarios, like uploading multiple files, a custom upload protocol is required, and both the client and server need to provide corresponding support.</p><p>Wouldn&rsquo;t it be better if there was a standard for such a common need? To address this issue, <a href=https://tools.ietf.org/html/rfc1867 title="RFC 1867">RFC 1867</a> was created. Its main content includes:</p><ul><li>Adding a file option for the input tag&rsquo;s type.</li><li>Adding the <code>multipart/form-data</code> option for the form&rsquo;s enctype.</li></ul><p>Below is a form that supports file submission.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>form</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>action</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://httpbin.org/post&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>method</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;post&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>enctype</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;multipart/form-data&#34;</span>
</span></span><span style=display:flex><span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;text&#34;</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;words&#34;</span>/&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;file&#34;</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;uploadfile1&#34;</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;file&#34;</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;uploadfile2&#34;</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;submit&#34;</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>form</span>&gt;
</span></span></code></pre></td></tr></table></div></div><p>After submitting the form, you will see the content of the request roughly like this:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-HTTP data-lang=HTTP><span style=display:flex><span><span style=color:#a6e22e>POST</span> http://httpbin.org/post <span style=color:#66d9ef>HTTP</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1.1</span>
</span></span><span style=display:flex><span>Content-Type<span style=color:#f92672>:</span> <span style=color:#ae81ff>multipart/form-data; boundary=285fa365bd76e6378f91f09f4eae20877246bbba4d31370d3c87b752d350</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>multipart/form-data; boundary=285fa365bd76e6378f91f09f4eae20877246bbba4d31370d3c87b752d350
</span></span><span style=display:flex><span>--285fa365bd76e6378f91f09f4eae20877246bbba4d31370d3c87b752d350
</span></span><span style=display:flex><span>Content-Disposition: form-data; name=&#34;uploadFile1&#34;; filename=&#34;uploadfile1.txt&#34;
</span></span><span style=display:flex><span>Content-Type: application/octet-stream
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>upload file1
</span></span><span style=display:flex><span>--285fa365bd76e6378f91f09f4eae20877246bbba4d31370d3c87b752d350
</span></span><span style=display:flex><span>Content-Disposition: form-data; name=&#34;uploadFile1&#34;; filename=&#34;uploadfile2.txt&#34;
</span></span><span style=display:flex><span>Content-Type: application/octet-stream
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>upload file2
</span></span><span style=display:flex><span>--285fa365bd76e6378f91f09f4eae20877246bbba4d31370d3c87b752d350
</span></span><span style=display:flex><span>Content-Disposition: form-data; name=&#34;words&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>123
</span></span><span style=display:flex><span>--285fa365bd76e6378f91f09f4eae20877246bbba4d31370d3c87b752d350--
</span></span></code></pre></td></tr></table></div></div><p>Note: If you use Chrome&rsquo;s developer tools, for performance reasons, you won&rsquo;t be able to see this part of the content. Moreover, if the submission is a binary stream, it&rsquo;s just a mess, and there&rsquo;s nothing to see.</p><p>Apart from <code>multipart/form-data</code>, Content-Type also includes additional content such as <code>boundary=xxx</code>. <code>Boundary</code> means boundary and is similar to <code>&</code> in the <code>application/x-www-form-urlencoded</code> method, used to separate different input fields. The reason why <code>boundary</code> is so complicated is that general text content can be separated using <code>&</code>, but if it&rsquo;s a file stream, <code>&</code> might conflict with the content, hence the higher requirement for the uniqueness of the boundary.</p><p>The detailed format of <code>multipart/form-data</code> content will not be introduced here. Let&rsquo;s continue to discuss how to implement this functionality in Go.</p><h2 id=implementation>Implementation</h2><p>How to implement file uploads in Go?</p><p>The main logic is still the three steps: organizing data, setting Content-Type, and sending the request. However, the organization of this part of the data is much more complicated than the urlencoded method of the form submission.</p><p>Go&rsquo;s simplicity shines through at this moment because the standard library <code>mime/multipart</code> has already provided very convenient methods, eliminating the need for manual organization.</p><p>Suppose we now want to implement the functionality of the previous form submission, i.e., submit two files, uploadfile1 and uploadfile2, and a field words.</p><p>First, create a <code>byte.Buffer</code> type variable, <code>body</code>, to save the data. On top of it, create a <code>multipart.Writer</code> to organize the data to be submitted. The code is as</p><p>follows:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>bodyBuf</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Buffer</span>{}
</span></span><span style=display:flex><span><span style=color:#a6e22e>writer</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>multipart</span>.<span style=color:#a6e22e>NewWriter</span>(<span style=color:#a6e22e>payloadBuf</span>)
</span></span></code></pre></td></tr></table></div></div><p>First, organize the file content. The organization logic for the two files is the same, so let&rsquo;s introduce it using uploadfile1 as an example. On top of <code>writer</code>, create a <code>fileWriter</code> to write the content of the file uploadFile1,</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>fileWriter</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>writer</span>.<span style=color:#a6e22e>CreateFormFile</span>(<span style=color:#e6db74>&#34;uploadFile1&#34;</span>, <span style=color:#a6e22e>filename</span>)
</span></span></code></pre></td></tr></table></div></div><p>Open the file to be uploaded, uploadfile1, and copy the file content to <code>fileWriter</code>, as follows:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#e6db74>&#34;uploadfile1&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Copy</span>(<span style=color:#a6e22e>fileWriter</span>, <span style=color:#a6e22e>f</span>)
</span></span></code></pre></td></tr></table></div></div><p>Adding fields is very simple. Suppose we set <code>words</code> to 123. The code is as follows:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>writer</span>.<span style=color:#a6e22e>WriteField</span>(<span style=color:#e6db74>&#34;words&#34;</span>, <span style=color:#e6db74>&#34;123&#34;</span>)
</span></span></code></pre></td></tr></table></div></div><p>After completing all content settings, be sure to close the <code>Writer</code>. Otherwise, the request body will lack the end boundary.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>writer</span>.<span style=color:#a6e22e>Close</span>()
</span></span></code></pre></td></tr></table></div></div><p>The data organization is completed.</p><p>Next, just set the data to <code>http.Post</code>.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Post</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;http://httpbin.org/post&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>writer</span>.<span style=color:#a6e22e>FormDataContentType</span>(),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>body</span>,
</span></span><span style=display:flex><span>)
</span></span></code></pre></td></tr></table></div></div><p>The form submission supporting file upload is completed.</p><h2 id=conclusion>Conclusion</h2><p>This post mainly introduces how to implement file uploads using Go, essentially organizing the request body for submitting files. To clearly understand the process of organizing the request body, one must be familiar with the related HTTP protocol, <a href=https://tools.ietf.org/html/rfc1867 title="rfc 1867">rfc 1867</a>.</p><p>Blog post: <a href=http://en.poloxue.com/posts/2019-12-10-golang-http-upload-file/>The Go Developer&rsquo;s Guide to HTTP File Uploads</a></p></div><nav class="hide-on-mobile section-nav"><nav id=TableOfContents><ol><li><a href=#introduction>Introduction</a></li><li><a href=#submitting-forms>Submitting Forms</a></li><li><a href=#file-upload-rfc-1867>File Upload RFC 1867</a></li><li><a href=#implementation>Implementation</a></li><li><a href=#conclusion>Conclusion</a></li></ol></nav></nav></div><div class=post><hr class=footer-separator><div class=tags></div><div class=back><a href=https://en.poloxue.com/><span aria-hidden=true>← Back</span></a></div><div class=back></div></div></div><div class="footer wrapper"><nav class=nav><div>2024 Polo Xue All rights reserved</div></nav></div><script>feather.replace()</script><script>var enableTruncate=!0,filterDepth=!1;const MAX_DEPTH=9;window.addEventListener("DOMContentLoaded",()=>{const e=new IntersectionObserver(e=>{e.reverse().forEach(e=>{const n=e.target.getAttribute("id");if(e.intersectionRatio>0){var t=document.querySelectorAll(`nav li a[href="#${n}"]`);t!=null&&t.forEach(e=>{if(e!=null){var t=getDepth(e.parentElement);filterDepth&&t<=MAX_DEPTH&&(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))}else filterDepth||(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))})}})});document.querySelectorAll("h1[id],h2[id],h3[id],h4[id]").forEach(t=>{e.observe(t)})});function isVisible(e){if(!(e instanceof Element))return!1;const n=getComputedStyle(e);if(n.display==="none")return!1;if(n.visibility!=="visible")return!1;if(n.opacity<.1)return!1;if(e.offsetWidth+e.offsetHeight+e.getBoundingClientRect().height+e.getBoundingClientRect().width===0)return!1;const t={x:e.getBoundingClientRect().left+e.offsetWidth/2,y:e.getBoundingClientRect().top+e.offsetHeight/2};if(t.x<0)return!1;if(t.x>(document.documentElement.clientWidth||window.innerWidth))return!1;if(t.y<0)return!1;if(t.y>(document.documentElement.clientHeight||window.innerHeight))return!1;let s=document.elementFromPoint(t.x,t.y);do if(s===e)return!0;while(s=s.parentNode)return!1}function clearActiveStatesInTableOfContents(){document.querySelectorAll("nav li").forEach(e=>{e.classList.remove("active")})}function getDepth(e){for(var t=0;e!==null&&e.tagName.toLowerCase()!=="ul";)t++,e=e.parentElement;return t}function navItems(){var e=document.querySelectorAll("nav nav li a");return Array.from(e).filter(e=>e.href!=null&&e.hash.startsWith("#"))}function lasItemInNavBarVisible(){var e=navItems().slice(-1)[0];return isVisible(e)}document.addEventListener("DOMContentLoaded",function(){if(!enableTruncate)return;var e=navItems();console.log(e),lasItemInNavBarVisible()||(filterDepth=!0,e.forEach(function(e){var t=getDepth(e.parentElement);t>MAX_DEPTH&&e.parentElement.classList.add("depth-nested")}))})</script></body></html>